
# 混合模型（MixedLM）+ 量产哨兵 + ML 残差修正 —— 阳极氧化 L*/a*/b* 方差收敛的统一框架（Part 1/2）

> **版本**：v2 (Quality-first)  
> **撰写时间**：2025-08-14  
> **作者**：Edwin ZhangLei & Copilot（协作）

---

## 目录（Part 1/2）
- 0. 背景与现场约束
- 1. 现网形态与直面问题
- 2. 第一次方案（最小改造思路）与弯路
- 3. 质量优先的重构：双形态统一引擎（V2 内核）
  - 3.1 总则与目标
  - 3.2 形态自动判别
  - 3.3 两种形态下的建模策略
- 4. “设参已固定（单一最优 config）”与 DOE 的共存机制
- 5. 何时引入 Machine Learning（ML）
- 6. 数据契约（CSV 列）与运行模板（Run/Measurement）

---

## 0. 背景与现场约束

- **现网部署**：前端 `doe_analysis_test_interface.html` / `MixedModelDOE_Web_V1.html` 负责上传 CSV、一键调用后端；后端为 Render.com 上的 FastAPI `app.py`，核心分析由 Python 完成；主接口 `/runDOE` 并提供文件列表/下载接口。该链路在你最近的前端文件和项目邮件中反复出现并被验证可用。参见：[doe_analysis_test_interface.html][R1]、[MixedModelDOE_Web_V1.html][R2][R3]、[架构邮件][R4][R5]。
- **方法论动因**：JMP/OLS 在你们 S2/量产数据上出现 **LOF 显著、RMSE 占容差带宽过大、纯误差与结构误差并存** 等问题，促使从 OLS/RSM 转向 **混合效应模型（MixedLM）**。参见：[Color S2 DOE 方法论背景说明][R6]。
- **工艺机理**：高装载（24→100 pcs）时，**电流密度分布、热/流场、化学耗竭、几何遮蔽、接触/供电**等因素使位置/班次/槽位依赖的方差被放大，导致 L*/a*/b* 的显著离散。这一点在你们的仿真报告与现场经验中得到证实（阴极/挡板优化可收窄膜厚/颜色分布）。参见：[阳极氧化仿真报告][R7]。
- **结论**：**随机结构**（`shift/load/flybarX/flybarY/tank`）与**协变量**（`entry_timestamp/queue_delay_sec/bath_age_hours/ambient_T/RH`）必须成为模型一等公民；同时尽量 **不破坏** 现有 HTML→FastAPI→Core 的用户体验与接口。

---

## 1. 现网形态与直面问题

### 1.1 现网形态
- **V0（早期）**：OLS/RSM 为主，适用于 DOE 寻优，但在真实工况下残差结构性强、LOF 显著。证据见 [R6]。
- **V1（过渡）**：已将 DOE 分析服务化（/runDOE），混合模型上线，但**随机项主要是 `config`**（26 点或若干配置），**尚未系统引入** `shift/load/位置/tank/时间偏差/槽龄/温湿度`。

### 1.2 痛点
- **统计**：仅以 `config` 作为随机项会混淆真实层级方差，无法解释“100 pcs 比 24 pcs 离散更大”的来源。
- **工程**：量产后 `dye1/dye2/Time/Temp` 固定，旧逻辑在“单一 config”时退化为“截距模型”，无法压缩方差/监控漂移。
- **运维**：希望**接口与前端不动**，但又不能“为了少改而牺牲质量”。

---

## 2. 第一次方案（最小改造）与弯路

### 2.1 最初想法（“最小改造”）
- 保持 `/runDOE` 与前端不变；
- 在核心引擎里 **自动探测** CSV 列：有 `shift/flybarX/flybarY/tank/queue_delay_sec/...` 就用；没有则自动降级（保持兼容）；
- 目标是以最小代价把真实层级和协变量引入 MixedLM。

### 2.2 弯路与反思
你明确提出：**“质量第一，不为少改牺牲建模质量。”**
如果仅“轻量嵌入”，会欠缺：
- **组外交叉验证（GroupKFold/LOGO）**，泛化评估不足；
- **稳健性与异方差处理**（HC3、Cook’s D/DFBETAS、权重）；
- **尾部风险（P95−P5、ΔE95）** 专项建模与覆盖率验证；
- **ML 残差修正**的可插拔管线与治理。
> 因此我们决定：**以质量为先进行一次核心重构**，同时保留接口/前端兼容——**双目标并行**。

---

## 3. 质量优先的重构：双形态统一引擎（V2 内核）

### 3.1 总则与目标
- **接口/体验保持不变**：沿用 `/runDOE` 与下载接口，前端无需改动（仅增加“可选列说明/模板下载”）。[R1][R2][R3]
- **核心能力完整上线**：
  1) **形态自动判别**（DOE vs 量产）；
  2) **高质量 MixedLM**（交叉随机效应 + 协变量 + REML）；
  3) **稳健与诊断**（HC3、Cook’s D/DFBETAS、QQ/残差-拟合、VIF/条件数、LOF 近似）；
  4) **组外验证**（GroupKFold/LOGO）与**报告固化**；
  5) **尾部/分位**（P95−P5、ΔE95）建模与覆盖率；
  6) **ML 残差修正插槽**与**漂移检测预留**。

### 3.2 形态自动判别
- 读取 `dye1/dye2/Time/Temp` 的**基数/跨度**：
  - 若四者均为单一值（或跨度 < ε）：→ **量产形态（PROD）**；
  - 只要有 ≥1 因子有 ≥3 水平或明显跨度：→ **DOE 形态**；
- 无需 UI 切换；日后做微扰或新 DOE，引擎会**自动切回 DOE**。

### 3.3 两种形态下的建模策略

**DOE 形态（探索/寻优/解释）**
- 固定效应：RSM（线性+二次+必要交互，遵守层级规则与可解释性）；
- 随机效应（交叉方差分量）：`(1|shift) + (1|load) + (1|flybarX) + (1|flybarY) + (1|tank)`，列有就上；
- 协变量：`queue_delay_sec`（建议 **B‑spline**）、`bath_age_hours`、`ambient_T/RH` 等；
- 诊断：**HC3**、**Cook’s D/DFBETAS**、**QQ/残差‑拟合**、**VIF/条件数**、**LOF 近似**、**组外 CV（按 load/shift 分组）**；
- 输出：效应图/Profiler、响应曲面/等高线、方差分量雷达、位点热力图、**分层 Ppk**、**ΔE95**、CV 指标。

**量产形态（设参固定 = 单一最优 config）**
- 固定效应：仅 **Intercept + 协变量**（四设参作为元数据记录；若微扰，自动回到 DOE）；
- 随机效应/协变量：同上；
- 诊断：同上；
- 输出：**组间/组内方差**、ICC、**BLUP 校正**后的位置地图、**滚动窗口（7/14 天）监控**、**漂移检测**（均值/方差/P95−P5/ΔE95）、**尾部分位**预测与覆盖率验证。

> **关键意义**：即使只有一个最优 config，仍可用随机结构与协变量实现**方差压缩**与**哨兵监控**；当你在最优点附近做微扰/小 DOE，形态会自动切换，形成**统一引擎**。

---

## 4. 固定 config 与 DOE 的共存机制

- **日常运行**：量产形态（参数固定）专注“方差分解 + 哨兵监控 + 尾部收紧”。
- **探索时刻**：当你在最优点周边做小范围试探（例如 `Time` ±0.5 min，`Temp` ±0.5 ℃），CSV 出现多水平，引擎**自动切回 DOE**，补充曲率与交互信息，并把结果纳入报告。
- **历史一致性**：所有报告文件沿用既有命名与下载接口，便于追溯与审计。

---

## 5. 何时引入 Machine Learning（ML）

> **三阶段策略**（与引擎形态无关，按数据与目标推进）：

1) **统计优先（MixedLM-only）**：DOE/量产初期，样本少、需显著性/方差归因与合规 —— **不引入 ML**；
2) **MixedLM + ML 残差修正**：当残差存在**系统结构**、**非线性/阈值**、**交互复杂**或对**尾部预测**（ΔE95、P95−P5）要求更高时，引入 **XGBoost/LightGBM/BART** 等在 **GroupKFold** 下学习 **MixedLM 残差**；最终预测 `ŷ = ŷ_Mixed + ŷ_ML(resid)`；
3) **ML 主导 + 统计校准**：数据规模大、实时性强、目标偏预测/预警时，ML 作为主引擎，MixedLM 提供**方差监控与校准**；结合**漂移检测**与**分布校准**（保守约束）。

---

## 6. 数据契约（CSV 列）与运行模板

### 6.1 固定因子（设参）
- `dye1, dye2, Time, Temp` —— 与现网一致。

### 6.2 随机因子（结构/层级，不必全部）
- `shift`（S1/S2/S3…）
- `load_id` / `rack_id`（架次/挂具编号；用于 `groups` 根）
- `flybarX, flybarY`（位置坐标或位号）
- `tank_id`（多槽时建议）
- `config`（可选；在 DOE 阶段是试验点标签，量产阶段可作为策略版本标签，亦可作为随机项）

### 6.3 协变量（非受控但可观测）
- `entry_timestamp`（入槽时间，秒级）
- `queue_delay_sec`（前道→入槽延迟，建议做 **B‑spline**）
- `bath_age_hours`（槽龄/换液后小时数/throughput）
- `ambient_T, ambient_RH`（温湿度）

### 6.4 响应变量
- `Lvalue, Avalue, Bvalue`

### 6.5 运行表（Run Plan，按班次分块，班次内随机）
| run_id | shift | dye1 | dye2 | Time | Temp | 备注 |
|---|---|---:|---:|---:|---:|---|
| S1-001 | S1 | 实测 | 实测 | 实测 | 实测 | BBD/CCD 组合或中心点 |
| … | … | … | … | … | … | … |

> **不要求编码（-1/0/+1）**，直接填实测值；`Time/Temp` 难切换时可采用**近似 split‑plot**（统计时用随机效应处理）。

### 6.6 测量表（Measurement，每行=一件/测点）
| run_id | shift | load_id | tank_id | flybarX | flybarY | part_id | entry_timestamp | queue_delay_sec | bath_age_hours | ambient_T | ambient_RH | Lvalue | Avalue | Bvalue |
|---|---|---|---|---|---|---|---|---:|---:|---:|---:|---:|---:|---:|
| S1-001 | S1 | L001 | T01 | 1 | 1 | P01 | 2025-08-14 09:32:11 | 18 | 6.2 | 27.5 | 62 | 48.3 | 12.9 | 8.6 |
| S1-001 | S1 | L001 | T01 | 2 | 3 | P02 | 2025-08-14 09:32:14 | 20 | 6.2 | 27.6 | 61 | 48.1 | 13.1 | 8.8 |

> **位置抽样建议**：每个 run 覆盖 ≥9 个位置（X×Y 的边/中/角），便于稳健估计 `flybarX/flybarY` 方差并做 **BLUP** 位置校正。

---

**参考与佐证**  
[R1] `doe_analysis_test_interface.html`（端点/字段/下载入口）  
[R2] `MixedModelDOE_Web_V1.html`（端点/字段/下载入口）  
[R3] （同 R2 的团队分享版本）  
[R4] 《Mixed Model DOE 项目完整架构解析》（HTML→app.py→Core）  
[R5] 《Mixed Model DOE AI Agent 项目可行性说明书》（目标与架构）  
[R6] 《Color S2 DOE 建模方法论背景说明（JMP→Mixed Model 的动因）》  
[R7] 《阳极氧化仿真报告_20250226》（阴极/挡板优化、厚度均匀性）  

